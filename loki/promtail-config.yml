server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  # Push des logs via le proxy NGINX
  - url: http://nginx:80/api/loki/push

scrape_configs:
  # Logs des conteneurs Docker
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container'

  # Logs NGINX - API RAG
  - job_name: nginx_rag
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx
          service: rag
          __path__: /var/log/nginx/rag-access.log
    pipeline_stages:
      - json:
          expressions:
            time: time
            remote_addr: remote_addr
            method: method
            request_uri: request_uri
            uri: uri
            status: status
            request_time: request_time
            request_body: request_body
            content_type: content_type
            content_length: content_length
      - labels:
          method:
          status:
      - timestamp:
          source: time
          format: RFC3339

  # Logs NGINX - API Braintrust
  - job_name: nginx_braintrust
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx
          service: braintrust
          __path__: /var/log/nginx/braintrust-access.log
    pipeline_stages:
      - json:
          expressions:
            time: time
            remote_addr: remote_addr
            method: method
            request_uri: request_uri
            uri: uri
            status: status
            request_time: request_time
            request_body: request_body
            content_type: content_type
            content_length: content_length
      - labels:
          method:
          status:
      - timestamp:
          source: time
          format: RFC3339

  # Logs NGINX - API SupaBase
  - job_name: nginx_supabase
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx
          service: supabase
          __path__: /var/log/nginx/supabase-access.log
    pipeline_stages:
      - json:
          expressions:
            time: time
            remote_addr: remote_addr
            method: method
            request_uri: request_uri
            uri: uri
            status: status
            request_time: request_time
            request_body: request_body
            content_type: content_type
            content_length: content_length
      - labels:
          method:
          status:
      - timestamp:
          source: time
          format: RFC3339

  # Logs NGINX - API N8N
  - job_name: nginx_n8n
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx
          service: n8n
          __path__: /var/log/nginx/n8n-access.log
    pipeline_stages:
      - json:
          expressions:
            time: time
            remote_addr: remote_addr
            method: method
            request_uri: request_uri
            uri: uri
            status: status
            request_time: request_time
            request_body: request_body
            content_type: content_type
            content_length: content_length
      - labels:
          method:
          status:
      - timestamp:
          source: time
          format: RFC3339

  # Logs NGINX - API Qdrant
  - job_name: nginx_qdrant
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx
          service: qdrant
          __path__: /var/log/nginx/qdrant-access.log
    pipeline_stages:
      - json:
          expressions:
            time: time
            remote_addr: remote_addr
            method: method
            request_uri: request_uri
            uri: uri
            status: status
            request_time: request_time
            request_body: request_body
            content_type: content_type
            content_length: content_length
      - labels:
          method:
          status:
      - timestamp:
          source: time
          format: RFC3339

  # Logs NGINX - Google Analytics Measurement Protocol
  - job_name: nginx_ga_mp
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx
          service: google_analytics_mp
          __path__: /var/log/nginx/ga-mp-access.log
    pipeline_stages:
      - json:
          expressions:
            time: time
            remote_addr: remote_addr
            method: method
            request_uri: request_uri
            uri: uri
            status: status
            request_time: request_time
            request_body: request_body
            content_type: content_type
            content_length: content_length
      - labels:
          method:
          status:
      - timestamp:
          source: time
          format: RFC3339

  # Logs NGINX - Google Analytics Data API
  - job_name: nginx_ga_data
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx
          service: google_analytics_data
          __path__: /var/log/nginx/ga-data-access.log
    pipeline_stages:
      - json:
          expressions:
            time: time
            remote_addr: remote_addr
            method: method
            request_uri: request_uri
            uri: uri
            status: status
            request_time: request_time
            request_body: request_body
            content_type: content_type
            content_length: content_length
      - labels:
          method:
          status:
      - timestamp:
          source: time
          format: RFC3339

  # Logs NGINX - Google Analytics Admin API
  - job_name: nginx_ga_admin
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx
          service: google_analytics_admin
          __path__: /var/log/nginx/ga-admin-access.log
    pipeline_stages:
      - json:
          expressions:
            time: time
            remote_addr: remote_addr
            method: method
            request_uri: request_uri
            uri: uri
            status: status
            request_time: request_time
            request_body: request_body
            content_type: content_type
            content_length: content_length
      - labels:
          method:
          status:
      - timestamp:
          source: time
          format: RFC3339

  # Logs NGINX - Ollama
  - job_name: nginx_ollama
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx
          service: ollama
          __path__: /var/log/nginx/ollama-access.log
    pipeline_stages:
      - json:
          expressions:
            time: time
            remote_addr: remote_addr
            method: method
            request_uri: request_uri
            uri: uri
            status: status
            request_time: request_time
            request_body: request_body
            content_type: content_type
            content_length: content_length
      - labels:
          method:
          status:
      - timestamp:
          source: time
          format: RFC3339
